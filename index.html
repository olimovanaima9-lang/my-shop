<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>My Market</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f5f6fa;}
.header{background:linear-gradient(90deg,#6a5cff,#8f7cff);color:white;padding:20px;font-weight:bold;}
.products{display:grid;grid-template-columns:1fr 1fr;gap:15px;padding:15px;}

.card{background:white;border-radius:20px;padding:10px;box-shadow:0 2px 8px rgba(0,0,0,0.05);}
.card img{width:100%;border-radius:15px;}
.price{font-weight:bold;margin-top:5px;}

.add-btn{
  margin-top:10px;width:100%;padding:10px;border:none;
  border-radius:12px;background:linear-gradient(90deg,#6a5cff,#8f7cff);
  color:white;font-weight:bold;cursor:pointer;
}

.bottom-nav{
  position:fixed;bottom:0;width:100%;background:white;
  display:flex;justify-content:space-around;padding:10px 0;
  border-top:1px solid #ddd;font-size:20px;
}

.cart-badge{
  background:red;color:white;border-radius:50%;
  padding:3px 7px;font-size:12px;position:absolute;
  margin-left:-10px;margin-top:-10px;
}

.modal{
  position:fixed;bottom:0;left:0;width:100%;background:white;
  border-top-left-radius:20px;border-top-right-radius:20px;
  padding:20px;box-shadow:0 -5px 20px rgba(0,0,0,0.2);
  display:none;max-height:70%;overflow:auto;
}

.quantity{display:flex;justify-content:center;align-items:center;margin:10px 0;}
.quantity button{
  width:35px;height:35px;border:none;border-radius:50%;
  background:#6a5cff;color:white;font-size:18px;cursor:pointer;
}
.quantity span{margin:0 15px;font-weight:bold;font-size:18px;}

.btn-row{display:flex;gap:10px;margin-top:10px;}
.btn-row button{
  flex:1;padding:10px;border:none;border-radius:12px;
  font-weight:bold;cursor:pointer;
}

.confirm{background:green;color:white;}
.cancel{background:#ccc;}

.cart-item{display:flex;justify-content:space-between;margin-bottom:8px;}
.remove{color:red;cursor:pointer;}
.total{font-weight:bold;margin-top:10px;}
</style>
</head>

<body>

<div class="header">üõç My Market</div>

<div class="products">
  <div class="card">
    <img src="https://picsum.photos/300/200?1">
    <div class="price">$40</div>
    <button class="add-btn" onclick="openProduct('WK-609',40)">
      Savatga qo‚Äòshish
    </button>
  </div>

  <div class="card">
    <img src="https://picsum.photos/300/200?2">
    <div class="price">$42</div>
    <button class="add-btn" onclick="openProduct('E406S',42)">
      Savatga qo‚Äòshish
    </button>
  </div>
</div>

<div class="bottom-nav">
  <div>üè†</div>
  <div onclick="openCart()" style="position:relative;">
    üõí
    <span id="cartCount" class="cart-badge" style="display:none;">0</span>
  </div>
  <div>‚ù§Ô∏è</div>
  <div>üë§</div>
</div>

<!-- PRODUCT MODAL -->
<div class="modal" id="productModal">
  <h3 id="productTitle"></h3>
  <div class="quantity">
    <button onclick="changeQty(-1)">‚àí</button>
    <span id="productQty">1</span>
    <button onclick="changeQty(1)">+</button>
  </div>
  <div class="btn-row">
    <button class="confirm" onclick="confirmAdd()">Savatga qo‚Äòshish</button>
    <button class="cancel" onclick="closeProduct()">Bekor qilish</button>
  </div>
</div>

<!-- CART MODAL -->
<div class="modal" id="cartModal">
  <h3>üõí Savat</h3>
  <div id="cartItems"></div>
  <div class="total" id="cartTotal"></div>
  <div class="btn-row">
    <button class="confirm" onclick="confirmOrder()">Buyurtmani tasdiqlash</button>
    <button class="cancel" onclick="closeCart()">Orqaga</button>
  </div>
</div>

<script>
let tg = window.Telegram?.WebApp;
if(tg) tg.expand();

let cart = {};
let currentProduct = null;
let currentPrice = 0;
let currentQty = 1;

function updateBadge(){
  let total = 0;
  Object.values(cart).forEach(i => total += i.qty);
  const badge = document.getElementById("cartCount");
  if(total>0){badge.style.display="inline-block";badge.innerText=total;}
  else{badge.style.display="none";}
}

function openProduct(name, price){
  currentProduct = name;
  currentPrice = price;
  currentQty = 1;
  document.getElementById("productTitle").innerText = name;
  document.getElementById("productQty").innerText = currentQty;
  document.getElementById("productModal").style.display="block";
}

function changeQty(delta){
  currentQty += delta;
  if(currentQty<1) currentQty=1;
  document.getElementById("productQty").innerText=currentQty;
}

function confirmAdd(){
  if(cart[currentProduct]){
    cart[currentProduct].qty += currentQty;
  } else {
    cart[currentProduct]={name:currentProduct,price:currentPrice,qty:currentQty};
  }
  updateBadge();
  closeProduct();
}

function closeProduct(){
  document.getElementById("productModal").style.display="none";
}

function openCart(){
  const itemsDiv=document.getElementById("cartItems");
  const totalDiv=document.getElementById("cartTotal");
  itemsDiv.innerHTML="";
  let total=0;

  for(let key in cart){
    let item=cart[key];
    let sum=item.price*item.qty;
    total+=sum;
    itemsDiv.innerHTML+=`
      <div class="cart-item">
        ${item.name} x${item.qty} - $${sum}
        <span class="remove" onclick="deleteItem('${key}')">‚ùå</span>
      </div>
    `;
  }

  totalDiv.innerText="üí∞ Jami: $"+total;
  document.getElementById("cartModal").style.display="block";
}

function deleteItem(key){
  delete cart[key];
  updateBadge();
  openCart();
}

function closeCart(){
  document.getElementById("cartModal").style.display="none";
}

function confirmOrder(){
  if(Object.keys(cart).length===0){
    alert("Savat bo‚Äòsh");
    return;
  }

  if(tg){
    tg.sendData(JSON.stringify(Object.values(cart)));
  }

  cart={};
  updateBadge();
  closeCart();
}
</script>

</body>
</html>
